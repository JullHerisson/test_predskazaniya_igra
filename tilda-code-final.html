<!-- ОПТИМИЗИРОВАННЫЙ КОД ДЛЯ TILDA -->
<!-- Исправляет проблемы с CSS конфликтами, растягиванием и попапами на мобильных -->

<div style="width: 100%; margin: 0; padding: 0; overflow: hidden; position: relative; box-sizing: border-box; max-width: 100vw;">
  <iframe id="charity-embed"
    src="https://test-predskazaniyaigra1.vercel.app" 
    width="100%" 
    height="2000px" 
    frameborder="0"
    scrolling="yes"
    style="border: none; display: block; margin: 0; padding: 0; vertical-align: top; position: relative; box-sizing: border-box; width: 100%; max-width: 100vw;"
    allowfullscreen
    loading="lazy"
    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
  ></iframe>
</div>

<style>
  /* Изоляция iframe от стилей Tilda */
  iframe {
    isolation: isolate !important;
    contain: layout style paint !important;
    width: 100% !important;
    max-width: 100vw !important;
  }

  /* Исправление для мобильных устройств */
  @media screen and (max-width: 768px) {
    iframe {
      width: 100vw !important;
      max-width: 100vw !important;
      -webkit-text-size-adjust: 100% !important;
    }
  }
</style>

<script>
  (function () {
    var iframe = document.getElementById('charity-embed');
    if (!iframe) {
      console.error('Charity embed iframe not found!');
      return;
    }
    
    var currentHeight = 2000; // Начальная высота
    var updateHeight = function(newHeight) {
      var h = parseInt(newHeight, 10);
      if (h && h > 100 && Math.abs(h - currentHeight) > 10) {
        // Обновляем только если разница больше 10px для избежания мерцания
        currentHeight = h;
        iframe.style.height = h + 'px';
        iframe.style.minHeight = h + 'px';
        iframe.style.maxHeight = h + 'px';
        console.log('Iframe height updated to:', h + 'px');
      }
    };
    
    // Слушаем сообщения от приложения в iframe
    window.addEventListener('message', function (e) {
      try {
        // Проверяем источник для безопасности (можно заменить на конкретный домен)
        if (e && e.data && e.data.type === 'APP_IFRAME_HEIGHT' && e.data.height) {
          var h = parseInt(e.data.height, 10);
          if (h > 0) {
            updateHeight(h);
          }
        }
      } catch (err) {
        console.error('Error handling message:', err);
      }
    });
    
    // Fallback: проверяем высоту iframe напрямую (работает только если same-origin)
    var checkHeight = function() {
      try {
        var iframeDoc = iframe.contentDocument || (iframe.contentWindow && iframe.contentWindow.document);
        if (iframeDoc && iframeDoc.body) {
          var bodyHeight = Math.max(
            iframeDoc.body.scrollHeight || 0,
            iframeDoc.body.offsetHeight || 0,
            iframeDoc.documentElement.clientHeight || 0,
            iframeDoc.documentElement.scrollHeight || 0,
            iframeDoc.documentElement.offsetHeight || 0
          );
          if (bodyHeight > 100) {
            updateHeight(bodyHeight + 20); // +20px для отступа
          }
        }
      } catch (err) {
        // Cross-origin ошибка - это нормально, используем только postMessage
      }
    };
    
    // Проверяем высоту несколько раз с интервалами
    setTimeout(checkHeight, 500);
    setTimeout(checkHeight, 1500);
    setTimeout(checkHeight, 3000);
    
    // Периодическая проверка каждые 3 секунды
    var intervalId = setInterval(checkHeight, 3000);
    
    // Останавливаем интервал через 30 секунд (достаточно для первоначальной загрузки)
    setTimeout(function() {
      clearInterval(intervalId);
    }, 30000);
    
    console.log('Charity embed iframe height listener initialized');
  })();
</script>

<!-- Центрирование iframe и блокировка скролла страницы во время оверлеев из приложения -->
<script>
  (function () {
    var iframe = document.getElementById('charity-embed');
    if (!iframe) return;

    function getViewportHeight() {
      try { return (window.visualViewport && window.visualViewport.height) || window.innerHeight; } catch { return window.innerHeight; }
    }

    function scrollIframeToViewportCenter() {
      try {
        // Сначала центрируем нативно:
        if (iframe.scrollIntoView) {
          iframe.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'auto' });
        }
        var rect = iframe.getBoundingClientRect();
        var viewportCenterY = getViewportHeight() / 2;
        var iframeCenterY = rect.top + rect.height / 2;
        var delta = iframeCenterY - viewportCenterY;
        // Точная подстройка
        window.scrollBy({ top: delta, left: 0, behavior: 'auto' });
      } catch {}
    }

    function forceCenteringBurst() {
      // Несколько попыток с небольшими задержками — для iOS/Safari/шапок Тильды
      var steps = [0, 120, 280, 520, 900, 1300, 1800];
      steps.forEach(function (t) { setTimeout(scrollIframeToViewportCenter, t); });
    }

    function lockBodyScroll() {
      document.body.dataset._scrollY = String(window.scrollY || 0);
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.top = '-' + (window.scrollY || 0) + 'px';
    }
    function unlockBodyScroll() {
      var y = parseInt(document.body.dataset._scrollY || '0', 10) || 0;
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.top = '';
      window.scrollTo(0, y);
    }

    // Простая система модалки в родителе (Тильда)
    var popupEl = null;
    function ensurePopup() {
      if (popupEl) return popupEl;
      popupEl = document.createElement('div');
      popupEl.id = 'charity-parent-modal';
      popupEl.style.position = 'fixed';
      popupEl.style.inset = '0';
      popupEl.style.zIndex = '99999';
      popupEl.style.display = 'none';
      popupEl.style.alignItems = 'center';
      popupEl.style.justifyContent = 'center';
      popupEl.style.padding = '1rem';
      popupEl.style.background = 'rgba(0,0,0,0.85)';

      var card = document.createElement('div');
      card.style.maxWidth = '28rem';
      card.style.width = 'min(100%, 28rem)';
      card.style.maxHeight = 'min(88vh, 100%)';
      card.style.overflow = 'auto';
      card.style.border = '2px solid rgba(255,255,255,0.25)';
      card.style.borderRadius = '16px';
      card.style.backdropFilter = 'blur(6px)';
      card.style.background = 'rgba(18,18,20,0.95)';
      card.style.color = 'white';
      card.style.padding = '24px';
      card.style.position = 'relative';
      card.style.boxShadow = '0 20px 60px rgba(0,0,0,0.45)';

      var closeBtn = document.createElement('button');
      closeBtn.setAttribute('type','button');
      closeBtn.setAttribute('aria-label','Закрыть');
      closeBtn.innerHTML = '\u2715';
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '12px';
      closeBtn.style.right = '12px';
      closeBtn.style.width = '36px';
      closeBtn.style.height = '36px';
      closeBtn.style.borderRadius = '8px';
      closeBtn.style.background = 'rgba(255,255,255,0.08)';
      closeBtn.style.color = 'white';
      closeBtn.style.border = 'none';
      closeBtn.style.cursor = 'pointer';
      closeBtn.onclick = function () { hidePopup(); };

      var title = document.createElement('h2');
      title.textContent = 'Твоё новогоднее предсказание';
      title.style.fontSize = '20px';
      title.style.margin = '0 0 12px 0';
      title.style.opacity = '0.8';

      var text = document.createElement('p');
      text.id = 'charity-parent-modal-text';
      text.style.fontSize = '24px';
      text.style.lineHeight = '1.4';
      text.style.fontWeight = '700';
      text.style.margin = '8px 0 16px 0';

      var footer = document.createElement('div');
      footer.style.textAlign = 'center';
      footer.style.fontSize = '12px';
      footer.style.opacity = '0.7';
      footer.textContent = 'Фонд «Игра» • Детство не ждёт';

      card.appendChild(closeBtn);
      card.appendChild(title);
      card.appendChild(text);
      card.appendChild(footer);
      popupEl.appendChild(card);
      document.body.appendChild(popupEl);
      return popupEl;
    }

    function showPopup(predictionText) {
      ensurePopup();
      var t = document.getElementById('charity-parent-modal-text');
      if (t) t.textContent = predictionText || '';
      // Блокируем фон
      lockBodyScroll();
      popupEl.style.display = 'flex';
    }

    function hidePopup() {
      if (!popupEl) return;
      popupEl.style.display = 'none';
      unlockBodyScroll();
    }

    window.addEventListener('message', function (e) {
      if (!e || !e.data || !e.data.type) return;
      if (e.data.type === 'APP_OVERLAY_OPEN') {
        // Не блокируем скролл страницы на Тильде — только центрируем
        unlockBodyScroll();
        forceCenteringBurst();
      } else if (e.data.type === 'APP_OVERLAY_CLOSE') {
        // Ничего не делаем: скролл уже свободный
      } else if (e.data.type === 'APP_SCROLL_TO_MACHINE') {
        // Центрируем iframe, когда в приложении запускается анимация
        forceCenteringBurst();
      } else if (e.data.type === 'APP_SCROLL_DELTA' && typeof e.data.deltaY === 'number') {
        try {
          window.scrollBy({ top: e.data.deltaY, left: 0, behavior: 'auto' });
        } catch (err) {}
      } else if (e.data.type === 'APP_SHOW_PREDICTION' && e.data.prediction && e.data.prediction.text) {
        // Показываем нативную модалку в родителе с текстом предсказания
        showPopup(String(e.data.prediction.text || ''));
      }
    });

    // Перецентрирование при изменении окна/ориентации
    ['resize', 'orientationchange'].forEach(function (ev) {
      window.addEventListener(ev, function () { setTimeout(scrollIframeToViewportCenter, 150); });
    });
  })();
</script>
